{% extends "base.html" %}

{% block title %}Imports - {{ project_name }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_imports.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_imports.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="app-layout">
    {% include 'components/sidebar.html' %}

    <main class="app-content main-content imports-page">
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2"><i class="fas fa-arrow-down"></i> Manage Imports</h1>
            <div>
                <button class="btn btn-warning text-dark me-2"
                    onclick="window.location.href='{{ url_for('se_auto_import') }}'">
                    <i class="fas fa-bolt"></i> Auto import
                </button>
                <button class="btn btn-info text-white me-2" data-bs-toggle="modal" data-bs-target="#ocrImportModal">
                    <i class="fas fa-magic"></i> OCR Invoice
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createImportModal">
                    <i class="fas fa-plus"></i> Create Import
                </button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">Total import orders</h5>
                        <h2 id="totalImports">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Completed</h5>
                        <h2 id="completedImports">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">Total amount</h5>
                        <h2 id="totalAmount">0 VND</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Import orders list</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Order code</th>
                                <th>Supplier</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Import date</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="importsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border" role="status"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Create Import Modal -->
<div class="modal fade" id="createImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Import Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createImportForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" name="supplier_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Notes</label>
                            <input type="text" class="form-control" name="notes">
                        </div>
                    </div>

                    <hr>
                    <h6>Items</h6>
                    <div class="table-responsive mb-3">
                        <table class="table table-bordered" id="importItemsTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th width="150">Quantity</th>
                                    <th width="200">Unit Price</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="importItemsBody">
                                <!-- Items will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addImportItemRow()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitImport()">Create Import</button>
            </div>
        </div>
    </div>
</div>

<!-- View Import Modal -->
<div class="modal fade" id="viewImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Code:</strong> <span id="viewImportCode"></span><br>
                        <strong>Supplier:</strong> <span id="viewImportSupplier"></span><br>
                        <strong>Date:</strong> <span id="viewImportDate"></span>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Status:</strong> <span id="viewImportStatus"></span><br>
                        <strong>Total:</strong> <span id="viewImportTotal" class="h5 text-primary"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Notes:</strong> <span id="viewImportNotes"></span>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product Code</th>
                                <th>Product Name</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="viewImportItemsBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- OCR Import Modal -->
<div class="modal fade" id="ocrImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-robot"></i> OCR Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    Upload an invoice image (JPG, PNG) to automatically extract products and quantities using our Deep
                    Learning model.
                </div>

                <form id="ocrImportForm">
                    <div class="mb-3">
                        <label class="form-label">Invoice Image</label>
                        <input type="file" class="form-control" id="ocrFile" accept="image/*" required>
                    </div>
                    <div class="text-center" id="ocrLoading" style="display:none;">
                        <div class="progress mb-2" style="height: 25px;">
                            <div id="ocrProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <p id="ocrStatusText" class="small mt-1 text-center font-monospace"
                            style="min-height: 1.5em; transition: color 0.3s;">Initializing...</p>
                    </div>
                    <div id="ocrResult" style="display:none;">
                        <h6>Extracted Data <small class="text-muted">(editable)</small>:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th width="80">Qty</th>
                                        <th width="100">Price</th>
                                        <th width="100">Total</th>
                                        <th width="40"></th>
                                    </tr>
                                </thead>
                                <tbody id="ocrItemsBody"></tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning small">
                            <i class="fas fa-info-circle"></i> Please verify and edit the extracted data before saving.
                            Select existing products from dropdown or create new ones.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveOcrImport" disabled>Create Import</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}