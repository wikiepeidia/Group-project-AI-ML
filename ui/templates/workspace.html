{% extends "base.html" %}

{% block title %}Workflow Studio - Fun Work Hub{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='workspace_scenario.css') }}">
{% endblock %}

{% block content %}
<div class="scenario-wrapper">
    {% include 'components/sidebar.html' %}

    <main class="scenario-main">
        <section class="workspace-launchpad">
            <div>
                <p class="launch-eyebrow">Workspace shortcuts</p>
                <h2>Chọn chế độ xây dựng</h2>
            </div>
            <div class="launch-grid">
                <button class="launch-card disabled" type="button">
                    <div class="launch-icon gradient-pink"><i class="fas fa-robot"></i></div>
                    <div>
                        <h4>AI Tự động</h4>
                        <p>Đang phát triển · Tự động hóa bằng AI đang được hoàn thiện</p>
                    </div>
                    <span class="coming-soon">Soon</span>
                </button>
                <button class="launch-card active" type="button" onclick="openScrapingScenario()">
                    <div class="launch-icon gradient-blue"><i class="fas fa-layer-group"></i></div>
                    <div>
                        <h4>Scraping + CRM Sync</h4>
                        <p>Thu thập dữ liệu và đồng bộ CRM giống Make.com</p>
                    </div>
                    <span class="launch-cta">Mở scenario</span>
                </button>
                <button class="launch-card disabled" type="button">
                    <div class="launch-icon gradient-green"><i class="fas fa-code"></i></div>
                    <div>
                        <h4>Custom Workflow</h4>
                        <p>Đang phát triển · Sẽ hỗ trợ API/Webhook tùy chỉnh</p>
                    </div>
                    <span class="coming-soon">Soon</span>
                </button>
            </div>
        </section>

        <section class="wallet-glance" id="walletGlanceSection">
            <div class="glance-head">
                <div>
                    <p class="launch-eyebrow">Ví & Subscription</p>
                    <h2>Tình trạng nâng cấp Manager</h2>
                </div>
                <div class="glance-actions">
                    <button class="btn btn-outline-secondary" type="button" onclick="redirectToWallet()">
                        <i class="fas fa-wallet"></i> Quản lý ví
                    </button>
                    <button class="btn btn-success" type="button" onclick="redirectToWallet('#planGrid')">
                        <i class="fas fa-rocket"></i> Nâng cấp ngay
                    </button>
                </div>
            </div>
            <div class="glance-grid">
                <div class="glance-card">
                    <p>Ví khả dụng</p>
                    <h3 id="glanceBalance">—</h3>
                    <span id="glanceUpdatedAt" class="glance-subtext">Đang tải...</span>
                </div>
                <div class="glance-card">
                    <p>Gói hiện tại</p>
                    <h3 id="glancePlan">Chưa nâng cấp</h3>
                    <span id="glanceRenew" class="glance-chip">Auto renew: —</span>
                </div>
                <div class="glance-card">
                    <p>Thời hạn</p>
                    <h3 id="glanceExpiry">—</h3>
                    <span id="glanceStatus" class="glance-subtext">Đang kiểm tra...</span>
                </div>
            </div>
        </section>

        <header class="scenario-topbar" id="scenarioTop">
            <div class="scenario-title">
                <span class="scenario-chip">Scenario #FW-204</span>
                <h1>CRM Sync & Customer Delight</h1>
                <p>Luồng tự động đồng bộ dữ liệu đa nền tảng giống Make.com</p>
            </div>
            <div class="scenario-actions">
                <button class="btn btn-outline-secondary" onclick="duplicateScenario()">
                    <i class="fas fa-clone"></i> Duplicate
                </button>
                <button class="btn btn-outline-secondary" onclick="scheduleScenario()">
                    <i class="far fa-clock"></i> Lịch chạy
                </button>
                <button class="btn btn-light" onclick="saveScenario()">
                    <i class="fas fa-save"></i> Lưu draft
                </button>
                <button class="btn btn-success" onclick="runScenarioNow()">
                    <i class="fas fa-play"></i> Run once
                </button>
            </div>
        </header>

        <section class="scenario-layout">
            <aside class="scenario-sidebar" id="scenarioSidebar">
                <div class="sidebar-header">
                    <h6>Module Library</h6>
                    <div class="badge bg-primary">+240 integrations</div>
                </div>
                <div class="input-group input-group-sm mb-3">
                    <span class="input-group-text bg-transparent text-light"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Tìm app, trigger, action..." id="moduleSearch"
                        oninput="filterModules()">
                </div>
                <div class="module-groups">
                    <button class="module-group active" data-group="all" onclick="switchModuleGroup(event, 'all')">
                        <i class="fas fa-layer-group"></i> Tất cả
                    </button>
                    <button class="module-group" data-group="trigger" onclick="switchModuleGroup(event, 'trigger')">
                        <i class="fas fa-bolt"></i> Triggers
                    </button>
                    <button class="module-group" data-group="action" onclick="switchModuleGroup(event, 'action')">
                        <i class="fas fa-cogs"></i> Actions
                    </button>
                    <button class="module-group" data-group="data" onclick="switchModuleGroup(event, 'data')">
                        <i class="fas fa-database"></i> Data
                    </button>
                </div>
                <div class="module-list" id="moduleLibrary"></div>
                <div class="sidebar-footer">
                    <p class="text-muted small mb-1">Không tìm thấy ứng dụng?</p>
                    <button class="btn btn-outline-secondary w-100 btn-sm" onclick="requestIntegration()">
                        <i class="fas fa-plug"></i> Đề nghị tích hợp mới
                    </button>
                </div>
            </aside>

            <section class="scenario-canvas-panel">
                <div class="canvas-toolbar">
                    <div class="toolbar-left">
                        <span class="status-dot online"></span> LIVE mode
                        <span class="toolbar-divider"></span>
                        <span>Auto-save: <strong>Enabled</strong></span>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-sm btn-outline-danger" id="clearCanvasBtn" onclick="clearAllNodes()"><i
                                class="fas fa-trash"></i> Clear all</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="zoomCanvas('out')"><i
                                class="fas fa-search-minus"></i></button>
                        <button class="btn btn-sm btn-outline-primary" onclick="zoomCanvas('reset')"><i
                                class="fas fa-compress"></i></button>
                        <button class="btn btn-sm btn-outline-primary" onclick="zoomCanvas('in')"><i
                                class="fas fa-search-plus"></i></button>
                    </div>
                </div>

                <div class="scenario-canvas" id="scenarioCanvas">
                    <div class="canvas-surface" id="canvasSurface">
                        <svg class="canvas-connections" id="canvasConnections" xmlns="http://www.w3.org/2000/svg"></svg>
                        <div class="canvas-grid"></div>
                    </div>
                </div>

                <div class="scenario-run-console" id="runConsole">
                    <div class="console-header">
                        <h6><i class="fas fa-terminal"></i> Run console</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearConsole()"><i
                                class="fas fa-broom"></i> Clear</button>
                    </div>
                    <pre id="consoleOutput">Ready. Waiting for run...</pre>
                </div>
            </section>

            <aside class="scenario-inspector">
                <div class="inspector-tabs">
                    <button class="inspector-tab active" data-tab="properties"
                        onclick="switchInspectorTab(event, 'properties')">Properties</button>
                    <button class="inspector-tab" data-tab="output"
                        onclick="switchInspectorTab(event, 'output')">Output</button>
                    <button class="inspector-tab" data-tab="versions"
                        onclick="switchInspectorTab(event, 'versions')">Versions</button>
                </div>
                <div class="inspector-content" id="inspectorContent">
                    <p class="text-muted">Chọn một module trong canvas để xem cấu hình chi tiết.</p>
                </div>
                <div class="run-history">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6>Run history</h6>
                        <span class="badge bg-secondary" id="runCounter">0 runs</span>
                    </div>
                    <ul class="run-history-list" id="runHistoryList"></ul>
                </div>
            </aside>
        </section>

        <footer class="scenario-statusbar">
            <div>
                <i class="fas fa-info-circle"></i> Last run: <strong id="lastRunTime">Chưa chạy</strong>
            </div>
            <div>
                <i class="fas fa-database"></i> Data processed: <strong id="dataProcessed">0 records</strong>
            </div>
            <div>
                <i class="fas fa-users"></i> Active collaborators: <strong>2</strong>
            </div>
            <div>
                <i class="fas fa-cloud-upload-alt"></i> Version: <strong>v1.4-draft</strong>
            </div>
        </footer>
    </main>
</div>

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='workspace_scenario.js') }}"></script>
<script>
    function redirectToWallet(hash) {
        let url = '/wallet';
        if (hash) url += hash;
        window.location.href = url;
    }
</script>
<script src="{{ url_for('static', filename='wallet.js') }}" defer></script>
{% endblock %}
{% endblock %}