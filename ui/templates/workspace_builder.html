{% extends "base.html" %}

{% block title %}Workflow Builder - Workflow Automation for Retail{% endblock %}

{% block body_class %}builder-page{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='builder.css') }}">
{% endblock %}

{% block content %}
<div class="builder-container">
    <aside class="tools-sidebar">
        <div class="sidebar-header">
            <div>
                <div class="sidebar-title">Workflow Builder</div>
                <div class="sidebar-subtitle">Design automations for retail</div>
            </div>
            <div class="user-menu">
                <button class="theme-toggle" type="button" data-theme-toggle title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                {% set avatar_source = (current_user.first_name or current_user.last_name or current_user.email or 'WA')
                %}
                <div class="user-avatar">{{ avatar_source[:1]|upper }}</div>
                <a href="{{ url_for('logout') }}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign out
                </a>
            </div>
        </div>

        <div class="search-box">
            <input type="search" id="toolSearch" class="search-input" placeholder="Search blocks or services...">
            <span class="search-icon">
                <i class="fas fa-search"></i>
            </span>
        </div>

        <div class="tools-list" id="toolsList">
            <div class="tool-category">
                <div class="category-title">Triggers</div>
                <div class="tool-item" draggable="true" data-category="trigger">
                    <div class="tool-icon flow-control">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Scheduled run</div>
                        <div class="tool-description">Trigger every X minutes/hours</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="trigger">
                    <div class="tool-icon webhooks">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Webhook</div>
                        <div class="tool-description">Receive events from the POS</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="trigger">
                    <div class="tool-icon airtable">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Inventory monitor</div>
                        <div class="tool-description">Alert when SKU levels drop</div>
                    </div>
                </div>
            </div>

            <div class="tool-category">
                <div class="category-title">AI & Logic</div>
                <div class="tool-item" draggable="true" data-category="ai">
                    <div class="tool-icon openai">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">AI classifier</div>
                        <div class="tool-description">Detect customer intent</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="logic">
                    <div class="tool-icon tools">
                        <i class="fas fa-random"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Branch</div>
                        <div class="tool-description">Route based on conditions</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="logic">
                    <div class="tool-icon http">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Delay</div>
                        <div class="tool-description">Wait before next step</div>
                    </div>
                </div>
            </div>

            <div class="tool-category">
                <div class="category-title">Integrations</div>
                <div class="tool-item" draggable="true" data-category="integration">
                    <div class="tool-icon google-sheets">
                        <i class="fas fa-table"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Google Sheets</div>
                        <div class="tool-description">Log order activity</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="integration">
                    <div class="tool-icon tools">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Slack</div>
                        <div class="tool-description">Notify operations team</div>
                    </div>
                </div>
                <div class="tool-item" draggable="true" data-category="integration">
                    <div class="tool-icon http">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="tool-info">
                        <div class="tool-name">Email</div>
                        <div class="tool-description">Send reports to managers</div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <section class="builder-canvas">
        <div class="canvas-header">
            <div>
                <div class="canvas-title">Workflow Automation Canvas</div>
                <div class="nav-breadcrumb">
                    <a href="{{ url_for('workspace') }}" class="nav-link">Workspace</a>
                    <span class="nav-separator">/</span>
                    <span class="nav-link">Builder</span>
                </div>
            </div>
            <div class="canvas-actions">
                <button class="action-btn" type="button">
                    <i class="fas fa-undo"></i>
                    Undo
                </button>
                <button class="action-btn primary" type="button">
                    <i class="fas fa-save"></i>
                    Save workflow
                </button>
            </div>
        </div>

        <svg class="connections-svg" id="connectionLines" aria-hidden="true"></svg>

        <div class="workflow-canvas" id="workflowCanvas">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">
                    <i class="fas fa-mouse-pointer"></i>
                </div>
                <div class="drop-zone-title">Drag &amp; drop to begin</div>
                <div class="drop-zone-description">
                    Drop blocks from the left panel to build a smarter retail workflow.
                </div>
            </div>

            <div class="workflow-node" style="top: 160px; left: 180px;" data-title="Trigger: New order">
                <div class="node-header">
                    <div class="node-icon" style="background: #8bc34a;">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <div class="node-title">Trigger: New order</div>
                    <div class="node-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
                <div class="node-content">
                    Sync new orders from the POS every five minutes and push them through this workflow.
                </div>
                <div class="node-connections">
                    <div class="connection-point input"></div>
                    <div class="connection-point output"></div>
                </div>
            </div>

            <div class="workflow-node" style="top: 360px; left: 460px;" data-title="Slack notification">
                <div class="node-header">
                    <div class="node-icon" style="background: #00a67e;">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="node-title">Slack notification</div>
                    <div class="node-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
                <div class="node-content">
                    Send a message to #retail-ops when a VIP order exceeds five million VND.
                </div>
                <div class="node-connections">
                    <div class="connection-point input"></div>
                    <div class="connection-point output"></div>
                </div>
            </div>
        </div>

        <aside class="property-panel" id="propertyPanel">
            <div class="property-header">
                <div class="property-title" id="selectedNodeTitle">Node properties</div>
                <button class="close-panel" type="button" id="closePropertyPanel">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="form-group">
                <label for="nodeName" class="form-label">Node name</label>
                <input type="text" id="nodeName" class="form-input" placeholder="Trigger: New order">
            </div>

            <div class="form-group">
                <label for="nodeDescription" class="form-label">Description</label>
                <textarea id="nodeDescription" class="form-textarea" rows="4"
                    placeholder="Summarize what this block does..."></textarea>
            </div>

            <div class="form-group">
                <label for="nodeChannel" class="form-label">Channel</label>
                <select id="nodeChannel" class="form-select">
                    <option>Slack - #retail-ops</option>
                    <option>Email - retail@company.com</option>
                    <option>Google Sheets - Orders</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nodeCondition" class="form-label">Condition</label>
                <input type="text" id="nodeCondition" class="form-input" placeholder="order.total &gt;= 5000000">
            </div>

            <button class="action-btn primary full-width" type="button">
                <i class="fas fa-save"></i>
                Save changes
            </button>
        </aside>

        <div class="floating-toolbar">
            <button class="toolbar-btn active" type="button" data-action="cursor">
                <i class="fas fa-mouse-pointer"></i>
                Select
            </button>
            <button class="toolbar-btn" type="button" data-action="connect">
                <i class="fas fa-route"></i>
                Connect
            </button>
            <button class="toolbar-btn" type="button" data-action="zoom">
                <i class="fas fa-search-plus"></i>
                Zoom
            </button>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toolSearch = document.getElementById('toolSearch');
        const toolItems = Array.from(document.querySelectorAll('.tool-item'));
        const propertyPanel = document.getElementById('propertyPanel');
        const selectedNodeTitle = document.getElementById('selectedNodeTitle');
        const closePropertyPanel = document.getElementById('closePropertyPanel');
        const nodeNameInput = document.getElementById('nodeName');
        const nodeDescriptionInput = document.getElementById('nodeDescription');
        const canvas = document.getElementById('workflowCanvas');
        const dropZone = document.getElementById('dropZone');
        const builderState = {
            nodeCounter: document.querySelectorAll('.workflow-node').length,
            selectedNode: null
        };
        const categoryColors = {
            trigger: '#8bc34a',
            ai: '#00bcd4',
            logic: '#ff9800',
            integration: '#9c27b0',
            custom: '#667eea'
        };

        if (toolSearch) {
            toolSearch.addEventListener('input', function (event) {
                const term = event.target.value.toLowerCase();
                toolItems.forEach(function (item) {
                    const matches = item.textContent.toLowerCase().includes(term);
                    item.style.display = matches ? 'flex' : 'none';
                });
            });
        }

        function serializeTool(tool) {
            return {
                name: tool.querySelector('.tool-name')?.textContent.trim() || 'Custom block',
                description: tool.querySelector('.tool-description')?.textContent.trim() || 'Describe this step...',
                icon: tool.querySelector('.tool-icon i')?.className || 'fas fa-puzzle-piece',
                category: tool.dataset.category || 'custom'
            };
        }

        function getCategoryColor(category) {
            return categoryColors[category] || categoryColors.custom;
        }

        function updateDropZoneVisibility() {
            if (!dropZone || !canvas) {
                return;
            }
            const hasNodes = canvas.querySelectorAll('.workflow-node').length > 0;
            dropZone.style.display = hasNodes ? 'none' : 'flex';
        }

        function attachNodeInteractions(node) {
            if (!node) {
                return;
            }

            node.addEventListener('click', function (event) {
                // Avoid treating drag gestures as clicks
                if (event.target.closest('.node-menu')) {
                    return;
                }
                selectNode(node);
            });

            enableNodeDragging(node);
        }

        function enableNodeDragging(node) {
            const handle = node.querySelector('.node-header');
            if (!handle || !canvas) {
                return;
            }

            handle.addEventListener('mousedown', function (event) {
                if (event.button !== 0) {
                    return;
                }
                event.preventDefault();
                const canvasRect = canvas.getBoundingClientRect();
                const nodeRect = node.getBoundingClientRect();
                const offsetX = event.clientX - nodeRect.left;
                const offsetY = event.clientY - nodeRect.top;

                node.classList.add('dragging');

                function onMouseMove(moveEvent) {
                    const currentCanvasRect = canvas.getBoundingClientRect();
                    const newLeft = moveEvent.clientX - currentCanvasRect.left - offsetX;
                    const newTop = moveEvent.clientY - currentCanvasRect.top - offsetY;
                    node.style.left = `${Math.max(0, newLeft)}px`;
                    node.style.top = `${Math.max(0, newTop)}px`;
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    node.classList.remove('dragging');
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function selectNode(node) {
            if (!node) {
                return;
            }
            document.querySelectorAll('.workflow-node').forEach(function (item) {
                item.classList.remove('selected');
            });
            node.classList.add('selected');
            builderState.selectedNode = node;

            if (selectedNodeTitle) {
                selectedNodeTitle.textContent = node.dataset.title || 'Node properties';
            }

            if (nodeNameInput) {
                nodeNameInput.value = node.dataset.title || '';
            }

            if (nodeDescriptionInput) {
                nodeDescriptionInput.value = node.querySelector('.node-content')?.textContent.trim() || '';
            }

            if (propertyPanel) {
                propertyPanel.classList.add('open');
            }
        }

        function bindPropertyInputs() {
            if (nodeNameInput) {
                nodeNameInput.addEventListener('input', function (event) {
                    if (!builderState.selectedNode) {
                        return;
                    }
                    const value = event.target.value || 'Untitled block';
                    const titleEl = builderState.selectedNode.querySelector('.node-title');
                    if (titleEl) {
                        titleEl.textContent = value;
                    }
                    builderState.selectedNode.dataset.title = value;
                    if (selectedNodeTitle) {
                        selectedNodeTitle.textContent = value;
                    }
                });
            }

            if (nodeDescriptionInput) {
                nodeDescriptionInput.addEventListener('input', function (event) {
                    if (!builderState.selectedNode) {
                        return;
                    }
                    const value = event.target.value || 'Describe this step...';
                    const contentEl = builderState.selectedNode.querySelector('.node-content');
                    if (contentEl) {
                        contentEl.textContent = value;
                    }
                });
            }
        }

        function createWorkflowNode(toolData, position) {
            if (!canvas) {
                return null;
            }

            const node = document.createElement('div');
            node.className = 'workflow-node';
            node.dataset.title = toolData.name;
            node.dataset.category = toolData.category;
            node.style.top = `${position.y - 40}px`;
            node.style.left = `${position.x - 100}px`;
            node.style.position = 'absolute';

            node.innerHTML = `
                <div class="node-header">
                    <div class="node-icon" style="background: ${getCategoryColor(toolData.category)};">
                        <i class="${toolData.icon}"></i>
                    </div>
                    <div class="node-title">${toolData.name}</div>
                    <div class="node-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
                <div class="node-content">${toolData.description}</div>
                <div class="node-connections">
                    <div class="connection-point input"></div>
                    <div class="connection-point output"></div>
                </div>
            `;

            canvas.appendChild(node);
            builderState.nodeCounter += 1;
            attachNodeInteractions(node);
            updateDropZoneVisibility();
            selectNode(node);
            return node;
        }

        function handleDrop(event) {
            event.preventDefault();
            if (!canvas) {
                return;
            }

            const payload = event.dataTransfer.getData('application/json');
            if (!payload) {
                return;
            }
            const toolData = JSON.parse(payload);
            const canvasRect = canvas.getBoundingClientRect();
            const position = {
                x: event.clientX - canvasRect.left,
                y: event.clientY - canvasRect.top
            };
            createWorkflowNode(toolData, position);
        }

        if (canvas) {
            canvas.addEventListener('dragover', function (event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
            });
            canvas.addEventListener('drop', handleDrop);
        }

        if (dropZone) {
            dropZone.addEventListener('dragover', function (event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
            });
            dropZone.addEventListener('drop', handleDrop);
        }

        toolItems.forEach(function (tool) {
            tool.addEventListener('dragstart', function (event) {
                const payload = serializeTool(tool);
                event.dataTransfer.setData('application/json', JSON.stringify(payload));
                event.dataTransfer.effectAllowed = 'copy';
                canvas?.classList.add('drag-active');
            });

            tool.addEventListener('dragend', function () {
                canvas?.classList.remove('drag-active');
            });
        });

        if (closePropertyPanel && propertyPanel) {
            closePropertyPanel.addEventListener('click', function () {
                propertyPanel.classList.remove('open');
                if (builderState.selectedNode) {
                    builderState.selectedNode.classList.remove('selected');
                    builderState.selectedNode = null;
                }
            });
        }

        document.querySelectorAll('.toolbar-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.toolbar-btn').forEach(function (item) {
                    item.classList.remove('active');
                });
                btn.classList.add('active');
            });
        });

        document.querySelectorAll('.workflow-node').forEach(function (node) {
            attachNodeInteractions(node);
        });

        bindPropertyInputs();
        updateDropZoneVisibility();
    });
</script>
{% endblock %}