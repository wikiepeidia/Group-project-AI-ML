{% extends "base.html" %}

{% block title %}Khách hàng{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include 'components/sidebar.html' %}

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="fas fa-users"></i> Quản lý Khách hàng</h1>
                <button class="btn btn-primary" onclick="openAddCustomerModal()">
                    <i class="fas fa-plus"></i> Thêm khách hàng
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Mã KH</th>
                                    <th>Tên khách hàng</th>
                                    <th>Số điện thoại</th>
                                    <th>Email</th>
                                    <th>Địa chỉ</th>
                                    <th>Ghi chú</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border" role="status"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal: Add/Edit Customer -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalTitle">Thêm Khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="customerId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Mã KH <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerCode" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tên khách hàng <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-control" id="customerPhone">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Địa chỉ</label>
                    <input type="text" class="form-control" id="customerAddress">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú</label>
                    <textarea class="form-control" id="customerNotes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<style>
.main-content {
    margin-left: 260px;
}
</style>

<script>
let customersData = [];
let editingId = null;

async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        const data = await response.json();
        
        if (data.success) {
            customersData = data.customers;
            renderCustomersTable();
        } else {
            showAlert('error', 'Lỗi tải dữ liệu');
        }
    } catch (error) {
        showAlert('error', 'Lỗi: ' + error.message);
    }
}

function renderCustomersTable() {
    const tbody = document.getElementById('customersTableBody');
    
    if (customersData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có khách hàng nào</td></tr>';
        return;
    }
    
    tbody.innerHTML = customersData.map(customer => `
        <tr>
            <td><strong>${customer.code}</strong></td>
            <td>${customer.name}</td>
            <td>${customer.phone || '-'}</td>
            <td>${customer.email || '-'}</td>
            <td>${customer.address || '-'}</td>
            <td>${customer.notes || '-'}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editCustomer(${customer.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id}, '${customer.code}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function openAddCustomerModal() {
    editingId = null;
    document.getElementById('customerModalTitle').textContent = 'Thêm Khách hàng';
    document.getElementById('customerId').value = '';
    document.getElementById('customerCode').value = '';
    document.getElementById('customerCode').disabled = false;
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
    document.getElementById('customerAddress').value = '';
    document.getElementById('customerNotes').value = '';
    new bootstrap.Modal(document.getElementById('customerModal')).show();
}

function editCustomer(id) {
    const customer = customersData.find(c => c.id === id);
    if (!customer) return;
    
    editingId = id;
    document.getElementById('customerModalTitle').textContent = 'Sửa Khách hàng';
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerCode').value = customer.code;
    document.getElementById('customerCode').disabled = true;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerPhone').value = customer.phone || '';
    document.getElementById('customerEmail').value = customer.email || '';
    document.getElementById('customerAddress').value = customer.address || '';
    document.getElementById('customerNotes').value = customer.notes || '';
    new bootstrap.Modal(document.getElementById('customerModal')).show();
}

async function saveCustomer() {
    const code = document.getElementById('customerCode').value.trim();
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    const email = document.getElementById('customerEmail').value.trim();
    const address = document.getElementById('customerAddress').value.trim();
    const notes = document.getElementById('customerNotes').value.trim();
    
    if (!code || !name) {
        showAlert('error', 'Vui lòng điền đầy đủ thông tin bắt buộc');
        return;
    }
    
    const payload = { code, name, phone, email, address, notes };
    
    try {
        let response;
        if (editingId) {
            response = await fetch(`/api/customers/${editingId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        } else {
            response = await fetch('/api/customers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', editingId ? 'Cập nhật thành công!' : 'Thêm khách hàng thành công!');
            bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
            loadCustomers();
        } else {
            showAlert('error', data.message);
        }
    } catch (error) {
        showAlert('error', 'Lỗi: ' + error.message);
    }
}

async function deleteCustomer(id, code) {
    if (!confirm(`Bạn chắc chắn muốn xóa khách hàng "${code}"?`)) return;
    
    try {
        const response = await fetch(`/api/customers/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', 'Xóa thành công!');
            loadCustomers();
        } else {
            showAlert('error', data.message);
        }
    } catch (error) {
        showAlert('error', 'Lỗi: ' + error.message);
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('main').insertBefore(alertDiv, document.querySelector('main').firstChild);
    setTimeout(() => alertDiv.remove(), 5000);
}

document.addEventListener('DOMContentLoaded', loadCustomers);
</script>
{% endblock %}
